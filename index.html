<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Dashboard CRPOP - Efetivo e Viaturas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            text-align: center;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .controls {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .search-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: stretch;
        }
        
        .search-input {
            flex: 2;
            min-width: 250px;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #2a5298;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            flex: 1;
            min-width: 200px;
        }
        
        .file-input {
            position: absolute;
            left: -9999px;
        }
        
        .file-label {
            padding: 12px 25px;
            background: #28a745;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: block;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
        }
        
        .file-label:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .clear-btn {
            padding: 12px 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            white-space: nowrap;
            min-width: 140px;
        }
        
        .clear-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
            justify-content: flex-start;
        }
        
        .filter-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            background: #2a5298;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .filter-btn:hover {
            background: #1e3c72;
            transform: translateY(-2px);
        }
        
        .filter-btn.active {
            background: #28a745;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-left: 5px solid #2a5298;
        }
        
        .stat-card.rpmon {
            border-left-color: #28a745;
        }
        
        .stat-card.bpm {
            border-left-color: #dc3545;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #2a5298;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 1.1em;
        }
        
        .data-grid {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow-x: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .data-table th {
            background: #2a5298;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
            border-bottom: 3px solid #1e3c72;
            position: sticky;
            top: 0;
        }
        
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .data-table tr.highlight {
            background: #e8f5e8;
            border-left: 4px solid #28a745;
        }
        
        .efetivo-cell {
            font-weight: bold;
            color: #2a5298;
        }
        
        .viaturas-cell {
            font-weight: bold;
            color: #28a745;
        }
        
        .ratio-cell {
            font-style: italic;
            color: #666;
        }
        
        .regiao-tag {
            padding: 4px 12px;
            border-radius: 15px;
            color: white;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .regiao-3rpmon {
            background: #28a745;
        }
        
        .regiao-38bpm {
            background: #dc3545;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
        
        .upload-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        
        .upload-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .upload-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        @media (max-width: 768px) {
            .search-section {
                flex-direction: column;
                gap: 10px;
            }
            
            .search-input {
                width: 100%;
                min-width: unset;
            }
            
            .file-input-wrapper {
                min-width: unset;
            }
            
            .clear-btn {
                width: 100%;
                min-width: unset;
            }
            
            .filter-buttons {
                justify-content: center;
                gap: 8px;
            }
            
            .filter-btn {
                flex: 1;
                min-width: 100px;
                font-size: 0.9em;
                padding: 8px 12px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .stat-number {
                font-size: 2em;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöî Dashboard CRPOP</h1>
            <p>Controle de Efetivo e Viaturas - 3¬∫ RPMon e 38¬∫ BPM</p>
        </div>
        
        <div class="controls">
            <div class="search-section">
                <input type="text" class="search-input" id="searchInput" placeholder="Buscar munic√≠pio...">
                
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv">
                    <label for="fileInput" class="file-label">
                        üìä Carregar Planilha
                    </label>
                </div>
                
                <button class="clear-btn" onclick="limparDados()">
                    üóëÔ∏è Limpar Dados
                </button>
            </div>
            
            <div id="uploadStatus" class="upload-status"></div>
            
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterData('all')">Todos (0)</button>
                <button class="filter-btn" onclick="filterData('3rpmon')">3¬∫ RPMon (0)</button>
                <button class="filter-btn" onclick="filterData('38bpm')">38¬∫ BPM (0)</button>
                <button class="filter-btn" onclick="filterData('with-efetivo')">Com Efetivo</button>
                <button class="filter-btn" onclick="filterData('with-viaturas')">Com Viaturas</button>
                <button class="filter-btn" onclick="filterData('sem-cobertura')">Sem Cobertura</button>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalMunicipios">0</div>
                <div class="stat-label">Munic√≠pios Total</div>
            </div>
            <div class="stat-card rpmon">
                <div class="stat-number" id="totalEfetivo3rpmon">0</div>
                <div class="stat-label">Efetivo 3¬∫ RPMon</div>
            </div>
            <div class="stat-card bpm">
                <div class="stat-number" id="totalEfetivo38bpm">0</div>
                <div class="stat-label">Efetivo 38¬∫ BPM</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalEfetivo">0</div>
                <div class="stat-label">Efetivo Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalViaturas">0</div>
                <div class="stat-label">Viaturas Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="coberturaPercentual">0%</div>
                <div class="stat-label">Cobertura</div>
            </div>
        </div>
        
        <div class="data-grid">
            <h3>üìã Distribui√ß√£o por Munic√≠pio - Total: <span id="totalMunicipiosTabela">0</span> munic√≠pios</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Munic√≠pio</th>
                        <th>Regi√£o</th>
                        <th>Efetivo (24h)</th>
                        <th>Viaturas (24h)</th>
                        <th>Raz√£o E/V</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        console.log('Dashboard iniciado - Vers√£o 2.0');
        
        // Sistema din√¢mico - n√£o depende de lista fixa de munic√≠pios
        let municipiosBase = []; // Ser√° preenchido dinamicamente
        let dadosAtuais = [];
        let filtroAtual = 'all';

        function inicializarMunicipiosVazios() {
            // Criar lista vazia inicial para exibi√ß√£o
            municipiosBase = [
                { municipio: "AGUARDANDO PLANILHA...", regiao: "N/A", efetivo: 0, viaturas: 0 }
            ];
            dadosAtuais = [...municipiosBase];
            console.log('Sistema inicializado - aguardando planilha');
        }

        function determinarRegiao(nomeMunicipio) {
            // Lista dos munic√≠pios do 3¬∫ RPMon (os outros ser√£o 38¬∫ BPM)
            const municipios3rpmon = [
                '√ÅGUA SANTA', 'CAMARGO', 'CASCA', 'CHARRUA', 'CIR√çACO', 'COXILHA',
                'DAVID CANABARRO', 'DOIS LAJEADOS', 'ERNESTINA', 'GENTIL', 'GUAPOR√â',
                'MARAU', 'MATO CASTELHANO', 'MONTAURI', 'MULITERNO', 'NICOLAU VERGUEIRO',
                'NOVA ALVORADA', 'PASSO FUNDO', 'PONT√ÉO', 'SANTA CEC√çLIA DO SUL',
                'SANTO ANT√îNIO DO PALMA', 'S√ÉO DOMINGOS DO SUL', 'S√ÉO VALENTIM DO SUL',
                'SERAFINA CORR√äA', 'SERT√ÉO', 'TAPEJARA', 'UNI√ÉO DA SERRA', 'VANINI',
                'VILA L√ÇNGARO', 'VILA MARIA'
            ];

            const nomeNormalizado = nomeMunicipio.toUpperCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            
            const eh3rpmon = municipios3rpmon.some(m => {
                const mNormalizado = m.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                return nomeNormalizado === mNormalizado || 
                       nomeNormalizado.includes(mNormalizado) || 
                       mNormalizado.includes(nomeNormalizado);
            });

            return eh3rpmon ? "3¬∫ RPMon" : "38¬∫ BPM";
        }

        function processarPlanilhaEspecifica(jsonData) {
            let municipiosProcessados = 0;

            try {
                console.log('=== IN√çCIO PROCESSAMENTO DV ===');
                console.log('Total de linhas na planilha:', jsonData.length);
                
                // Verificar se temos pelo menos 4 linhas
                if (jsonData.length < 4) {
                    throw new Error('Planilha DV deve ter pelo menos 4 linhas');
                }
                
                // Extrair dados da estrutura espec√≠fica da planilha DV
                const municipiosLinha = jsonData[0] || [];  // Linha 1: nomes dos munic√≠pios
                const efetivosLinha = jsonData[2] || [];    // Linha 3: efetivos
                const viaturasLinha = jsonData[3] || [];    // Linha 4: viaturas

                console.log('Munic√≠pios linha length:', municipiosLinha.length);
                console.log('Efetivos linha length:', efetivosLinha.length);
                console.log('Viaturas linha length:', viaturasLinha.length);
                
                console.log('Munic√≠pios linha (primeiros 10):', municipiosLinha.slice(0, 10));
                console.log('Efetivos linha (primeiros 10):', efetivosLinha.slice(0, 10));
                console.log('Viaturas linha (primeiros 10):', viaturasLinha.slice(0, 10));

                // Resetar lista de munic√≠pios
                municipiosBase = [];
                console.log('Lista de munic√≠pios resetada');

                // Determinar quantas colunas processar (menor entre as tr√™s linhas)
                const maxColunas = Math.min(
                    municipiosLinha.length,
                    efetivosLinha.length,
                    viaturasLinha.length
                );
                
                console.log('M√°ximo de colunas a processar:', maxColunas);

                // Processar dados a partir da coluna B (√≠ndice 1)
                for (let i = 1; i < maxColunas; i++) {
                    const nomeMunicipio = municipiosLinha[i];
                    
                    // Pular c√©lulas vazias ou "TOTAL"
                    if (!nomeMunicipio || 
                        nomeMunicipio.toString().toUpperCase().trim() === 'TOTAL' ||
                        nomeMunicipio.toString().toUpperCase().trim() === '') {
                        console.log(`Pulando √≠ndice ${i}: "${nomeMunicipio}"`);
                        continue;
                    }

                    // Verificar se temos dados de efetivo e viaturas para este √≠ndice
                    const efetivo = (efetivosLinha[i] !== undefined && efetivosLinha[i] !== null) 
                        ? parseInt(efetivosLinha[i]) || 0 
                        : 0;
                    
                    const viaturas = (viaturasLinha[i] !== undefined && viaturasLinha[i] !== null) 
                        ? parseInt(viaturasLinha[i]) || 0 
                        : 0;
                        
                    const regiao = determinarRegiao(nomeMunicipio.toString());

                    console.log(`[${i}] Processando ${nomeMunicipio}: Efetivo ${efetivo}, Viaturas ${viaturas}, Regi√£o ${regiao}`);

                    // Adicionar munic√≠pio √† base din√¢mica
                    municipiosBase.push({
                        municipio: nomeMunicipio.toString().toUpperCase().trim(),
                        regiao: regiao,
                        efetivo: efetivo,
                        viaturas: viaturas
                    });

                    municipiosProcessados++;
                }

                console.log(`Total processados: ${municipiosProcessados}`);
                console.log('Munic√≠piosBase final:', municipiosBase.length);

                // Verificar se processamos algum munic√≠pio
                if (municipiosProcessados === 0) {
                    throw new Error('Nenhum munic√≠pio foi processado. Verifique o formato da planilha.');
                }

                // Calcular totais
                const totalEfetivo = municipiosBase.reduce((sum, m) => sum + m.efetivo, 0);
                const totalViaturas = municipiosBase.reduce((sum, m) => sum + m.viaturas, 0);
                const total3rpmon = municipiosBase.filter(m => m.regiao === "3¬∫ RPMon").length;
                const total38bpm = municipiosBase.filter(m => m.regiao === "38¬∫ BPM").length;

                console.log(`Totais: Efetivo ${totalEfetivo}, Viaturas ${totalViaturas}`);
                console.log(`Regi√µes: 3¬∫ RPMon ${total3rpmon}, 38¬∫ BPM ${total38bpm}`);

                // Atualizar contadores dos filtros
                atualizarContadoresFiltros();
                console.log('Contadores atualizados');

                // Mostrar resultado detalhado
                let mensagem = `‚úÖ ${municipiosProcessados} munic√≠pios processados\n`;
                mensagem += `üèõÔ∏è 3¬∫ RPMon: ${total3rpmon} | 38¬∫ BPM: ${total38bpm}\n`;
                mensagem += `üìä Efetivo: ${totalEfetivo} | Viaturas: ${totalViaturas}`;

                mostrarStatus(mensagem, 'success');
                console.log('Status mostrado, chamando aplicarFiltros...');
                
                aplicarFiltros();
                console.log('Filtros aplicados com sucesso');
                
                console.log('=== PROCESSAMENTO CONCLU√çDO ===');

            } catch (error) {
                console.error('=== ERRO NO PROCESSAMENTO ===', error);
                mostrarStatus('‚ùå Erro ao processar planilha: ' + error.message, 'error');
                
                // Em caso de erro, manter estado inicial
                inicializarMunicipiosVazios();
                aplicarFiltros();
            }
        }

        function atualizarContadoresFiltros() {
            const total = municipiosBase.length;
            const total3rpmon = municipiosBase.filter(m => m.regiao === "3¬∫ RPMon").length;
            const total38bpm = municipiosBase.filter(m => m.regiao === "38¬∫ BPM").length;
            
            // Atualizar textos dos bot√µes
            const botoes = document.querySelectorAll('.filter-btn');
            if (botoes.length >= 3) {
                botoes[0].textContent = `Todos (${total})`;
                botoes[1].textContent = `3¬∫ RPMon (${total3rpmon})`;
                botoes[2].textContent = `38¬∫ BPM (${total38bpm})`;
            }
        }

        function calcularEstatisticas() {
            const totalMunicipios = municipiosBase.length;
            const totalEfetivo = municipiosBase.reduce((sum, item) => sum + item.efetivo, 0);
            const totalViaturas = municipiosBase.reduce((sum, item) => sum + item.viaturas, 0);
            
            const efetivo3rpmon = municipiosBase
                .filter(item => item.regiao === "3¬∫ RPMon")
                .reduce((sum, item) => sum + item.efetivo, 0);
            
            const efetivo38bpm = municipiosBase
                .filter(item => item.regiao === "38¬∫ BPM")
                .reduce((sum, item) => sum + item.efetivo, 0);
            
            const municipiosComCobertura = municipiosBase.filter(item => item.efetivo > 0 || item.viaturas > 0).length;
            const coberturaPercentual = totalMunicipios > 0 ? Math.round((municipiosComCobertura / totalMunicipios) * 100) : 0;

            document.getElementById('totalMunicipios').textContent = totalMunicipios;
            document.getElementById('totalEfetivo3rpmon').textContent = efetivo3rpmon;
            document.getElementById('totalEfetivo38bpm').textContent = efetivo38bpm;
            document.getElementById('totalEfetivo').textContent = totalEfetivo;
            document.getElementById('totalViaturas').textContent = totalViaturas;
            document.getElementById('coberturaPercentual').textContent = coberturaPercentual + '%';
            document.getElementById('totalMunicipiosTabela').textContent = totalMunicipios;
        }

        function getStatus(efetivo, viaturas) {
            if (efetivo === 0 && viaturas === 0) return "Sem Cobertura";
            if (efetivo > 0 && viaturas > 0) return "Cobertura Completa";
            if (efetivo > 0) return "Apenas Efetivo";
            if (viaturas > 0) return "Apenas Viaturas";
            return "N/A";
        }

        function getRazao(efetivo, viaturas) {
            if (viaturas === 0) return efetivo > 0 ? "‚àû" : "0";
            return (efetivo / viaturas).toFixed(1);
        }

        function renderizarTabela(dados) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';

            if (dados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">Nenhum munic√≠pio encontrado</td></tr>';
                return;
            }

            dados.forEach(item => {
                const row = document.createElement('tr');
                const status = getStatus(item.efetivo, item.viaturas);
                
                if (status === "Cobertura Completa") {
                    row.classList.add('highlight');
                }

                row.innerHTML = `
                    <td><strong>${item.municipio}</strong></td>
                    <td><span class="regiao-tag regiao-${item.regiao.replace('¬∫', '').replace(' ', '').toLowerCase()}">${item.regiao}</span></td>
                    <td class="efetivo-cell">${item.efetivo}</td>
                    <td class="viaturas-cell">${item.viaturas}</td>
                    <td class="ratio-cell">${getRazao(item.efetivo, item.viaturas)}</td>
                    <td>${status}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterData(tipo) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            filtroAtual = tipo;
            aplicarFiltros();
        }

        function aplicarFiltros() {
            let dadosFiltrados = [...municipiosBase];

            const termoBusca = document.getElementById('searchInput').value.toLowerCase();
            if (termoBusca) {
                dadosFiltrados = dadosFiltrados.filter(item => 
                    item.municipio.toLowerCase().includes(termoBusca)
                );
            }

            switch (filtroAtual) {
                case '3rpmon':
                    dadosFiltrados = dadosFiltrados.filter(item => item.regiao === "3¬∫ RPMon");
                    break;
                case '38bpm':
                    dadosFiltrados = dadosFiltrados.filter(item => item.regiao === "38¬∫ BPM");
                    break;
                case 'with-efetivo':
                    dadosFiltrados = dadosFiltrados.filter(item => item.efetivo > 0);
                    break;
                case 'with-viaturas':
                    dadosFiltrados = dadosFiltrados.filter(item => item.viaturas > 0);
                    break;
                case 'sem-cobertura':
                    dadosFiltrados = dadosFiltrados.filter(item => item.efetivo === 0 && item.viaturas === 0);
                    break;
            }

            dadosAtuais = dadosFiltrados;
            renderizarTabela(dadosAtuais);
            calcularEstatisticas();
        }

        function processarPlanilha(dados) {
            // Fun√ß√£o gen√©rica para outros formatos (mantida para compatibilidade)
            let municipiosAtualizados = 0;

            try {
                municipiosBase.forEach(municipio => {
                    municipio.efetivo = 0;
                    municipio.viaturas = 0;
                });

                dados.forEach((linha, index) => {
                    const nomeMunicipio = (
                        linha.municipio || linha.Munic√≠pio || linha.MUNICIPIO || linha.munic√≠pio ||
                        linha.nome || linha.Nome || linha.NOME ||
                        linha.cidade || linha.Cidade || linha.CIDADE ||
                        linha['Nome do Munic√≠pio'] || linha['NOME DO MUNICIPIO'] ||
                        linha.campo || linha.Campo || linha.CAMPO || ''
                    ).toString().trim().toUpperCase();

                    if (!nomeMunicipio) return;

                    const efetivo = parseInt(
                        linha.efetivo || linha.Efetivo || linha.EFETIVO ||
                        linha['Total Efetivo Empregado nas 24 horas'] ||
                        linha['efetivo_24h'] || linha['Efetivo 24h'] ||
                        linha.policiais || linha.Policiais || linha.POLICIAIS || 0
                    ) || 0;

                    const viaturas = parseInt(
                        linha.viaturas || linha.Viaturas || linha.VIATURAS ||
                        linha['Total Viaturas Empregadas nas 24 horas'] ||
                        linha['viaturas_24h'] || linha['Viaturas 24h'] ||
                        linha.carros || linha.Carros || linha.CARROS || 0
                    ) || 0;

                    const municipioEncontrado = municipiosBase.find(m => {
                        const nomeBase = m.municipio.toUpperCase();
                        return (
                            nomeBase === nomeMunicipio ||
                            nomeBase.includes(nomeMunicipio) ||
                            nomeMunicipio.includes(nomeBase) ||
                            nomeBase.normalize('NFD').replace(/[\u0300-\u036f]/g, '') === 
                            nomeMunicipio.normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                        );
                    });

                    if (municipioEncontrado) {
                        municipioEncontrado.efetivo = efetivo;
                        municipioEncontrado.viaturas = viaturas;
                        municipiosAtualizados++;
                    }
                });

                let mensagem = `‚úÖ ${municipiosAtualizados} munic√≠pios atualizados`;

                mostrarStatus(mensagem, municipiosAtualizados > 0 ? 'success' : 'error');
                aplicarFiltros();

            } catch (error) {
                mostrarStatus('‚ùå Erro ao processar planilha: ' + error.message, 'error');
                console.error('Erro completo:', error);
            }
        }

        function mostrarStatus(mensagem, tipo) {
            const status = document.getElementById('uploadStatus');
            status.className = `upload-status upload-${tipo}`;
            status.textContent = mensagem;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 8000);
        }

        function limparDados() {
            if (municipiosBase.length === 0 || municipiosBase[0].municipio === "AGUARDANDO PLANILHA...") {
                mostrarStatus('‚ÑπÔ∏è Nenhum dado para limpar. Carregue uma planilha primeiro.', 'success');
                return;
            }

            municipiosBase.forEach(municipio => {
                municipio.efetivo = 0;
                municipio.viaturas = 0;
            });
            
            aplicarFiltros();
            mostrarStatus('üóëÔ∏è Dados limpos! Todos os valores foram zerados.', 'success');
        }

        // Configurar upload de arquivo
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            console.log('=== IN√çCIO DO UPLOAD ===');
            console.log('Arquivo selecionado:', file.name, file.type, file.size);

            mostrarStatus('üìÇ Processando arquivo...', 'success');
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                console.log('=== ARQUIVO LIDO ===');
                try {
                    if (file.name.toLowerCase().includes('.csv')) {
                        console.log('Processando como CSV...');
                        // Processar CSV
                        const text = e.target.result;
                        const lines = text.split('\n');
                        const headers = lines[0].split(',').map(h => h.trim());
                        
                        const dadosCSV = lines.slice(1)
                            .filter(line => line.trim())
                            .map(line => {
                                const values = line.split(',').map(v => v.trim());
                                const obj = {};
                                headers.forEach((header, index) => {
                                    obj[header.toLowerCase().replace(/[^a-z0-9]/g, '')] = values[index] || '';
                                });
                                return obj;
                            });
                        
                        processarPlanilha(dadosCSV);
                    } else {
                        console.log('Processando como Excel...');
                        
                        // Verificar se XLSX est√° dispon√≠vel
                        if (typeof XLSX === 'undefined') {
                            throw new Error('Biblioteca XLSX n√£o carregada');
                        }
                        
                        // Processar Excel
                        const data = new Uint8Array(e.target.result);
                        console.log('Dados convertidos para Uint8Array, tamanho:', data.length);
                        
                        const workbook = XLSX.read(data, { type: 'array' });
                        console.log('Workbook criado:', workbook.SheetNames);
                        
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        console.log('Primeira planilha selecionada:', workbook.SheetNames[0]);
                        
                        // Verificar se √© uma planilha DV (formato espec√≠fico)
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { 
                            header: 1, 
                            raw: false 
                        });
                        
                        console.log('=== DEBUG: DADOS DA PLANILHA ===');
                        console.log('Total de linhas:', jsonData.length);
                        console.log('Primeira linha:', jsonData[0]);
                        console.log('Segunda linha:', jsonData[1]); 
                        console.log('Terceira linha:', jsonData[2]);
                        console.log('Quarta linha:', jsonData[3]);
                        
                        // Detectar formato da planilha DV
                        const primeiraLinha = jsonData[0] || [];
                        const segundaLinha = jsonData[1] || [];
                        const terceiraLinha = jsonData[2] || [];
                        
                        console.log('=== DEBUG: DETEC√á√ÉO DE FORMATO ===');
                        console.log('Primeira c√©lula:', primeiraLinha[0]);
                        console.log('Segunda linha primeira c√©lula:', segundaLinha[0]);
                        console.log('Terceira linha primeira c√©lula:', terceiraLinha[0]);
                        
                        // Detec√ß√£o mais flex√≠vel do formato DV
                        const isDvFormat = (
                            primeiraLinha[0] === 'CAMPO' ||
                            (segundaLinha[0] && segundaLinha[0].toString().includes('RESUMO')) ||
                            (terceiraLinha[0] && terceiraLinha[0].toString().includes('Total Efetivo'))
                        );
                        
                        // Verifica√ß√£o adicional: se a primeira linha tem muitos munic√≠pios
                        const temMunicipios = primeiraLinha && primeiraLinha.length > 10;
                        
                        // Formato DV se atende pelo menos uma condi√ß√£o E tem muitos munic√≠pios
                        const formatoDV = isDvFormat && temMunicipios;
                        
                        console.log('=== DEBUG: RESULTADO DETEC√á√ÉO ===');
                        console.log('√â formato DV (b√°sico)?', isDvFormat);
                        console.log('Tem muitos munic√≠pios?', temMunicipios);
                        console.log('Formato DV final?', formatoDV);
                        console.log('Condi√ß√£o 1 (CAMPO):', primeiraLinha[0] === 'CAMPO');
                        console.log('Condi√ß√£o 2 (RESUMO):', segundaLinha[0] && segundaLinha[0].toString().includes('RESUMO'));
                        console.log('Condi√ß√£o 3 (Efetivo):', terceiraLinha[0] && terceiraLinha[0].toString().includes('Total Efetivo'));
                        
                        if (formatoDV) {
                            console.log('üìã Detectado formato DV - processando...');
                            processarPlanilhaEspecifica(jsonData);
                        } else {
                            console.log('üìã Formato gen√©rico detectado - processando...');
                            // Formato gen√©rico
                            const jsonGenerico = XLSX.utils.sheet_to_json(firstSheet);
                            console.log('Dados gen√©ricos (primeiras 3 linhas):', jsonGenerico.slice(0, 3));
                            processarPlanilha(jsonGenerico);
                        }
                    }
                } catch (error) {
                    console.error('=== ERRO NO PROCESSAMENTO ===', error);
                    mostrarStatus('‚ùå Erro ao ler arquivo: ' + error.message, 'error');
                }
            };

            reader.onerror = function(error) {
                console.error('=== ERRO NA LEITURA DO ARQUIVO ===', error);
                mostrarStatus('‚ùå Erro ao ler arquivo', 'error');
            };

            if (file.name.toLowerCase().includes('.csv')) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }

            // Limpar o input para permitir recarregar o mesmo arquivo
            this.value = '';
        });

        // Configurar busca
        document.getElementById('searchInput').addEventListener('input', aplicarFiltros);

        // Inicializar sistema din√¢mico
        console.log('Inicializando dashboard...');
        inicializarMunicipiosVazios();
        aplicarFiltros();
        console.log('Dashboard inicializado com sucesso!');
    </script>
</body>
</html>
